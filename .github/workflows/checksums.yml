name: Generate ACIP Checksums

'on':
  push:
    branches: [main]
    paths:
      - 'ACIP_*.md'
      - 'integrations/**'
      - 'README.md'
      - '.github/workflows/checksums.yml'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: acip-checksums-main
  cancel-in-progress: true

jobs:
  generate-checksums:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Generate checksums and manifest
        run: |
          # Create checksums directory
          mkdir -p .checksums

          # Generate SHA256 checksums for all ACIP files
          echo "Generating checksums for ACIP files..."

          # Get commit timestamp + commit (stable across reruns for the same commit)
          COMMIT=$(git rev-parse HEAD)
          COMMIT_UNIX_TS=$(git show -s --format=%ct "$COMMIT")
          TIMESTAMP=$(date -u -d "@$COMMIT_UNIX_TS" +"%Y-%m-%dT%H:%M:%SZ")

          # Resolve latest and recommended versions.
          # - latest: highest ACIP_v_* version found
          # - recommended: RECOMMENDED_VERSION file if present, else latest
          LATEST_VERSION=$(ls ACIP_v_*.md 2>/dev/null | sed -E 's/ACIP_v_([0-9.]+)_.*/\1/' | sort -V | tail -1)
          RECOMMENDED_VERSION=$(cat RECOMMENDED_VERSION 2>/dev/null | tr -d '[:space:]' || true)
          if [ -z "${RECOMMENDED_VERSION:-}" ]; then
            RECOMMENDED_VERSION="$LATEST_VERSION"
          fi

          # Start building the versions array
          VERSIONS_JSON="["
          FIRST=true

          # Process main ACIP version files
          for file in ACIP_v_*.md; do
            if [ -f "$file" ]; then
              echo "Processing: $file"

              # Extract version from filename (e.g., ACIP_v_1.3_Full_Text.md -> 1.3)
              VERSION=$(echo "$file" | sed -E 's/ACIP_v_([0-9.]+)_.*/\1/')

              # Generate SHA256 checksum
              CHECKSUM=$(sha256sum "$file" | cut -d' ' -f1)

              # Get file size
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")

              # Get line count
              LINES=$(wc -l < "$file" | tr -d ' ')

              # Write individual checksum file
              echo "$CHECKSUM  $file" > ".checksums/${file%.md}.sha256"

              # Add to versions array
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                VERSIONS_JSON="$VERSIONS_JSON,"
              fi

              VERSIONS_JSON="$VERSIONS_JSON
                {
                  \"version\": \"$VERSION\",
                  \"file\": \"$file\",
                  \"sha256\": \"$CHECKSUM\",
                  \"size_bytes\": $SIZE,
                  \"lines\": $LINES,
                  \"tokens\": null,
                  \"raw_url\": \"https://raw.githubusercontent.com/${{ github.repository }}/$COMMIT/$file\"
                }"
            fi
          done

          VERSIONS_JSON="$VERSIONS_JSON
            ]"

          # Build integrations array
          INTEGRATIONS_JSON="["
          FIRST_INT=true

          # Process integration files (unique; include md + sh)
          while IFS= read -r intfile; do
            echo "Processing integration: $intfile"

              # Extract integration name from path
              INT_NAME=$(echo "$intfile" | cut -d'/' -f2)

              # Generate SHA256 checksum
              INT_CHECKSUM=$(sha256sum "$intfile" | cut -d' ' -f1)

              # Get file size
              INT_SIZE=$(stat -f%z "$intfile" 2>/dev/null || stat -c%s "$intfile")

              # Get line count
              INT_LINES=$(wc -l < "$intfile" | tr -d ' ')

              # Write individual checksum file
              SAFE_NAME=$(echo "$intfile" | tr '/' '_')
              echo "$INT_CHECKSUM  $intfile" > ".checksums/${SAFE_NAME%.md}.sha256"

              # Add to integrations array
              if [ "$FIRST_INT" = true ]; then
                FIRST_INT=false
              else
                INTEGRATIONS_JSON="$INTEGRATIONS_JSON,"
              fi

              INTEGRATIONS_JSON="$INTEGRATIONS_JSON
                {
                  \"integration\": \"$INT_NAME\",
                  \"file\": \"$intfile\",
                  \"sha256\": \"$INT_CHECKSUM\",
                  \"size_bytes\": $INT_SIZE,
                  \"lines\": $INT_LINES,
                  \"tokens\": null,
                  \"raw_url\": \"https://raw.githubusercontent.com/${{ github.repository }}/$COMMIT/$intfile\"
                }"
          done < <(find integrations -type f \( -name '*.md' -o -name '*.sh' \) -print | LC_ALL=C sort -u)

          INTEGRATIONS_JSON="$INTEGRATIONS_JSON
            ]"

          # Create final manifest
          cat > .checksums/manifest.json << EOF
          {
            "schema_version": "1.2",
            "project": "ACIP",
            "description": "Advanced Cognitive Inoculation Prompt - Checksums and Metadata",
            "repository": "https://github.com/${{ github.repository }}",
            "generated_at": "$TIMESTAMP",
            "commit": "$COMMIT",
            "recommended_version": "$RECOMMENDED_VERSION",
            "latest_version": "$LATEST_VERSION",
            "tokenizer": null,
            "versions": $VERSIONS_JSON,
            "integrations": $INTEGRATIONS_JSON,
            "verification": {
              "instructions": "To verify: sha256sum -c <version>.sha256",
              "example": "curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/.checksums/ACIP_v_1.3_Full_Text.sha256 | sha256sum -c"
            }
          }
          EOF

          # Pretty print the manifest
          cat .checksums/manifest.json

          # Also create a combined checksums file
          cat .checksums/*.sha256 > .checksums/SHA256SUMS 2>/dev/null || true

      - name: Upload generated checksums (unsigned) as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: acip-checksums
          path: .checksums/
          retention-days: 7

  sign-and-commit:
    if: github.ref == 'refs/heads/main'
    needs: generate-checksums
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Replace .checksums from generated artifact
        run: rm -rf .checksums

      - name: Download generated checksums
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: acip-checksums
          path: .checksums

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: 'v3.0.3'

      - name: Sign manifest (keyless)
        run: |
          if git diff --quiet -- .checksums/manifest.json && \
             [ -f .checksums/manifest.json.sig ] && \
             [ -f .checksums/manifest.json.pem ]; then
            echo "Manifest unchanged and signature/cert already present; skipping signing."
          else
            cosign sign-blob --yes \
              --bundle .checksums/manifest.json.bundle \
              --new-bundle-format=true \
              --output-signature .checksums/manifest.json.sig \
              --output-certificate .checksums/manifest.json.pem \
              .checksums/manifest.json
          fi

          # Normalize certificate to PEM for easier manual verification.
          if ! grep -q "BEGIN CERTIFICATE" .checksums/manifest.json.pem; then
            base64 -d .checksums/manifest.json.pem > .checksums/manifest.json.pem.decoded 2>/dev/null || true
            if grep -q "BEGIN CERTIFICATE" .checksums/manifest.json.pem.decoded; then
              mv .checksums/manifest.json.pem.decoded .checksums/manifest.json.pem
            else
              rm -f .checksums/manifest.json.pem.decoded
            fi
          fi

      - name: Commit checksums
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add .checksums/
          if git diff --staged --quiet; then
            echo "No changes to checksums"
          else
            git commit -m "Update ACIP checksums [skip ci]"
            git push origin HEAD:main
          fi

      - name: Upload checksums as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: acip-checksums-signed
          path: .checksums/
          retention-days: 90
